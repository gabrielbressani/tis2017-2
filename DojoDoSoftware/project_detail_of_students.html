<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Dojo do Software | Projetos</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="font-awesome/css/font-awesome.css" rel="stylesheet">

    <link href="css/animate.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">


    <!-- Toastr style -->
    <link href="css/plugins/toastr/toastr.min.css" rel="stylesheet">

    <style type="text/css">
        .mostrar-hover {
            display: none;
        }

        .mostrar:hover a{
            display: initial;
        }
    </style>

</head>

<body>

    <div id="wrapper" class="sk-loading">

    <nav class="navbar-default navbar-static-side" role="navigation">
        <div class="sidebar-collapse">
            <ul class="nav metismenu" id="side-menu">
                <li class="nav-header">
                    <div class="dropdown profile-element"> 
                        <span>
                            <img alt="image" class="img-circle" src="img/a4.jpg" style="width: 50px;">
                        </span>
                        <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                            <span class="clear"> <span class="block m-t-xs"> <strong class="font-bold">
                                Betão
                            </strong>
                             </span> <span class="text-muted text-xs block">Configurações <b class="caret"></b></span> </span> </a>
                        <ul class="dropdown-menu animated fadeInRight m-t-xs">
                            <li><a href="profile.html">Profile</a></li>
                            <li><a href="contacts.html">Contacts</a></li>
                            <li><a href="mailbox.html">Mailbox</a></li>
                            <li class="divider"></li>
                            <li><a href="login.html">Logout</a></li>
                        </ul>
                    </div>
                    <div class="logo-element">
                        &nbsp;
                    </div>
                </li>
                <li>
                    <a href="#">
                        <i class="fa fa-th-large"></i> 
                        <span class="nav-label">
                            Dashboard
                        </span>
                    </a>
                </li>
                <li class="active">
                    <a href="projects_of_studants.html">
                        <i class="fa fa-cube"></i> 
                        <span class="nav-label">
                            Projetos
                        </span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>

        <div id="page-wrapper" class="gray-bg">
        <div class="row border-bottom">
        <nav class="navbar navbar-static-top  " role="navigation" style="margin-bottom: 0">
        <div class="navbar-header">
            <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#"><i class="fa fa-bars"></i> </a>
        </div>

        <ul class="nav navbar-top-links navbar-right">
            <li>
                <span class="m-r-sm text-muted welcome-message">
                    Seja bem-vindo ao Dojo do Software.
                </span>
            </li>
            <li>
                <a href="login.html">
                    <i class="fa fa-sign-out"></i> 
                    Sair
                </a>
            </li>
        </ul>

        </nav>
        </div>
            <div class="row wrapper border-bottom white-bg page-heading">
                <div class="col-sm-4">
                    <h2>Detalhes do Projeto</h2>
                    <ol class="breadcrumb">
                        <li>
                            <a href="index.html">Home</a>
                        </li>
                        <li class="active">
                            <strong>Detalhes do Projeto</strong>
                        </li>
                    </ol>
                </div>
            </div>
        <div class="row">
            <div class="col-lg-9">
                <div class="wrapper wrapper-content animated fadeInUp">
                    <div class="ibox">
                        <div class="ibox-content sk-loading">

                            <div class="sk-spinner sk-spinner-double-bounce">
                                <div class="sk-double-bounce1"></div>
                                <div class="sk-double-bounce2"></div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="m-b-md">
                                        <h2 id="titulo-do-projeto"></h2>
                                    </div>
                                    <dl class="dl-horizontal">
                                        <dt>Status:</dt> 

                                        <dd>
                                            <span id="status-do-projeto" class="label">
                                                
                                            </span>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-5">
                                    <dl class="dl-horizontal">

                                        <dt>
                                            Criado por:
                                        </dt> 
                                        <dd>
                                            Alex Smith
                                        </dd>
                                        
                                        <dt class="m-t-sm">
                                            Empresa:
                                        </dt> 
                                        <dd class="m-t-sm">
                                            <a href="#" class="text-navy">
                                                InfinityWare
                                            </a> 
                                        </dd>
                                    </dl>
                                </div>
                                <div class="col-lg-7" id="cluster_info">
                                    <dl class="dl-horizontal" >
                                        <dt>
                                            Data de criação:
                                        </dt> 
                                        <dd id="data-de-criacao-do-projeto">
                                        </dd>

                                        <dt class="m-t-sm">
                                            Participantes:
                                        </dt>
                                        <dd class="m-t-sm">
                                            --
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <dl class="dl-horizontal">
                                        <dt>Evolução:</dt>
                                        <dd>
                                            <div class="progress progress-striped active m-b-sm">
                                                <div style="width: 0%;" class="progress-bar"></div>
                                            </div>
                                            <small>Seu projeto está <strong>0%</strong> completo.</small>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                            <div class="row m-t-sm">
                                <div class="col-lg-12">
                                <div class="panel blank-panel">
                                <div class="panel-heading">
                                    <div class="panel-options">
                                        <ul class="nav nav-tabs">
                                            <li id="lances-do-projeto-tab" style="display: none;">
                                                <a href="#lances-do-projeto-content" data-toggle="tab">
                                                Lances
                                                </a>
                                            </li>
                                            <li id="requisitos-do-projeto-tab" class="active">
                                                <a href="#requisitos-do-projeto-content" data-toggle="tab">
                                                    Requisitos
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="panel-body">

                                <div class="tab-content">
                                <div class="tab-pane" id="lances-do-projeto-content" style="display: none;">
                                    <div class="feed-activity-list">
                                        <div class="feed-element" id="propostas-template" style="display: none;">
                                            <a href="#" class="pull-left">
                                                <img alt="image" class="img-circle" src="img/a4.jpg">
                                            </a>
                                            <div class="media-body ">
                                                <small class="pull-right">Minutos atrás</small>

                                                <strong id="nome-do-estudante">
                                                    
                                                </strong> do grupo <strong>TIS-2017</strong> deu um lance. <br>

                                                <div id="proposta-do-estudante" class="well">
                                                    
                                                </div>
                                            </div>
                                        </div>
                                        <div class="feed-element">
                                            <a href="#" class="pull-left">
                                                <img alt="image" class="img-circle" src="img/a2.jpg">
                                            </a>
                                            <div class="media-body ">
                                                <small class="pull-right">2h atrás</small>

                                                <strong>
                                                    Marco Antônio
                                                </strong> do grupo <strong>TI9</strong> deu um lance. <br>

                                                <div class="well">
                                                    Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s.
                                                    Over the years, sometimes by accident, sometimes on purpose (injected humour and the like).
                                                </div>
                                            </div>
                                        </div>
                                        <div class="feed-element">
                                            <a href="#" class="pull-left">
                                                <img alt="image" class="img-circle" src="img/a3.jpg">
                                            </a>
                                            <div class="media-body ">
                                                 <strong>
                                                    Maria clara
                                                </strong> do grupo <strong>Arrumaí</strong> deu um lance. <br>

                                                <div class="well">
                                                    Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s.
                                                    Over the years, sometimes by accident, sometimes on purpose (injected humour and the like).
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="feed-element">
                                            <a href="#" class="pull-left">
                                                <img alt="image" class="img-circle" src="img/a5.jpg">
                                            </a>
                                            <div class="media-body ">
                                                 <strong>
                                                    Jussara Reis
                                                </strong> do grupo <strong>AwakenCode</strong> deu um lance. <br>

                                                <div class="well">
                                                    Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s.
                                                    Over the years, sometimes by accident, sometimes on purpose (injected humour and the like).
                                                </div>
                                            </div>
                                        </div>
                                        
                                    </div>

                                </div>
                                <div class="tab-pane active" id="requisitos-do-projeto-content">

                                   <table class="table table-striped">
                                        <thead>
                                        <tr>
                                            <th>Quem</th>
                                            <th>O que</th>
                                            <th>Porquê</th>
                                            <th width="10"></th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                            
                                            <tr id="linha-de-adicao-de-requisitos">
                                                <td>
                                                    <textarea placeholder="Digite quem..." style="border: none; resize: none;" 
                                                        id="requisito-quem"></textarea>
                                                </td>
                                                <td>
                                                    <textarea placeholder="Digite o que..." style="border: none; resize: none;" 
                                                        id="requisito-o-que"></textarea>
                                                </td>
                                                <td>
                                                    <textarea placeholder="Digite porque..." style="border: none; resize: none;"
                                                        id="requisito-porque"></textarea>
                                                </td>
                                                <td>
                                                    <button class="btn btn-xs btn-primary m-t-sm" onclick="adicionarRequisito()">
                                                        Adicionar
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>

                                </div>
                                </div>

                                </div>

                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="wrapper wrapper-content project-manager">
                    
                    <button onclick="$('#dar-um-lance').modal();" id="botao-dar-um-lance" 
                    class=" btn btn-sm btn-success col-md-12 m-b-sm" style="display: none;">
                        Dar um lance
                    </button>   
                    <hr>

                    <p id="resumo-do-projeto" class="small"></p>
                    
                    <hr>
                    
                    <p class="small font-bold">
                        <span id="prioridade-do-projeto">                            
                        </span>
                    </p>
                    
                    <hr>
                    
                    <h5>Categorias</h5>
                    
                    <ul id="lista-de-categorias" class="tag-list" style="padding: 0">
                    </ul>
                    
                    <hr>
                            
                         
                    
                </div>
            </div>
        </div>
        <div class="footer">
            <div class="pull-right">
                Software Livre
            </div>
            <div>
                <strong>Copyright</strong> Dojo do Software &copy; 2017-2017
            </div>
        </div>

        </div>
    </div>


<div  class="modal inmodal in" id="dar-um-lance" tabindex="-1" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
    <div class="modal-content animated bounceInRight">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Dar um lance</h4>
            </div>
            <div class="modal-body">
                <form role="form">
                    <div class="form-group">
                        <label>Diga como você pode ajudar seu cliente:</label>
                        <textarea id="descricao-da-proposta" placeholder="Comece a digitar..." class="form-control m-t-sm" rows="10"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <a class="btn btn-primary" onclick="darUmLance()">Enviar lance</a>
            </div>
        </div>
    </div>
</div>


    <!-- Mainly scripts -->
    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

    <!-- Custom and plugin javascript -->
    <script src="js/inspinia.js"></script>
    <script src="js/plugins/pace/pace.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/4.5.0/firebase.js"></script>

    <!-- Toastr script -->
    <script src="js/plugins/toastr/toastr.min.js"></script>
    
    <script>
        var config = 
        {
            apiKey: "AIzaSyDOUzqY1e9W76wx_wZz4yZfm6IlP4FzNdQ",
            authDomain: "dojodosoftware.firebaseapp.com",
            databaseURL: "https://dojodosoftware.firebaseio.com",
            projectId: "dojodosoftware",
            storageBucket: "dojodosoftware.appspot.com",
            messagingSenderId: "377101591716"
        };

        firebase.initializeApp(config);

        var database = firebase.database(); 
        var projetoCorrente =  null;
        var idDoProjetoCorrente = null;
        
        $(function () {
             obterProjetoPorId(parseInt(localStorage.getItem("idDoProjeto")));
        });

        function obterProjetoPorId(idDoProjeto) 
        {
            idDoProjetoCorrente = idDoProjeto;

            database.ref('/Projeto/' + idDoProjeto).once('value').then(
                function(snapshot) 
                { 
                    atualizarHtml(snapshot.val());
                });
        }

        function atualizarHtml(projetoJson) 
        {
            projetoCorrente  = projetoJson;

            $("#titulo-do-projeto")
                .html(projetoJson.TituloDoProjeto);

            $("#data-de-criacao-do-projeto")
                .html(projetoJson.DataDeCadastro);

            $("#resumo-do-projeto")
                .html(projetoJson.ResumoDoProjeto);

            atualizarPrioridade(projetoJson);

            atualizarCategorias(projetoJson);

            atualizarTabelaDeRequisitos(projetoJson);
            
            atualizarStatus(projetoJson);
            
            atualizarPropostas()

            $('.sk-loading').removeClass('sk-loading');
        }

        function atualizarStatus(projetoJson)
        {
            $("#status-do-projeto").html(projetoJson.Status);

            if(projetoJson.Status == 'Em Elaboração')
            {
                $("#status-do-projeto").addClass('label-info');

                $("#iniciar-leilao").show();
            }
            else if(projetoJson.Status == 'Disponível Para Lance')
            {
                $("#status-do-projeto").removeClass('label-info');
                $("#status-do-projeto").addClass('label-warning');
                
                $("#iniciar-leilao").hide();

                $("#lances-do-projeto-tab").addClass('active');
                $("#lances-do-projeto-content").addClass('active');

                $("#requisitos-do-projeto-tab").removeClass('active');
                $("#requisitos-do-projeto-content").removeClass('active');

                $("#lances-do-projeto-tab").show();
                $("#lances-do-projeto-content").show();

                $("#linha-de-adicao-de-requisitos").remove();
                $('.js-excluir').remove();
            }
        }

        function atualizarPrioridade(projetoJson)
        {
            if(projetoJson.Prioridade == 'Baixa')
            {
                $("#prioridade-do-projeto")
                    .html("<i class='fa fa-circle text-navy'></i> Prioridade baixa")
            }
            else if(projetoJson.Prioridade == 'Media')
            {
                $("#prioridade-do-projeto")
                    .html("<i class='fa fa-circle text-warning'></i> Prioridade média")
            }
            else
            {
                $("#prioridade-do-projeto")
                    .html("<i class='fa fa-circle text-danger'></i> Prioridade Alta")
            }
        }

        function atualizarCategorias(projetoJson)
        {
            $.each(projetoJson.Categorias, function(index, categoria) 
            {
                $("#lista-de-categorias")
                    .append('<li><a href=""><i class="fa fa-tag"></i> ' + categoria.nome + '</a></li>');
            });
        }

        function atualizarTabelaDeRequisitos(projetoJson)
        {
            $(".js-requisito").remove();

            $.each(projetoJson.Requisitos, function(index, requisito) 
            {
                if(requisito)
                {
                    var botaoDeExcluir = "<a class='btn btn-xs btn-danger pull-right mostrar-hover js-excluir' href='javascript:void(0)' data-id-do-requisito ='"  + index + "' onclick='excluirRequisito(this)'> Excluir</a>";

                    var html = "<tr class='js-requisito mostrar'><td>" 
                        + requisito.quem + "</td> <td>" 
                        + requisito.oQue + "</td> <td> " 
                        + requisito.porque + "</td><td style='vertical-align: middle'>"
                        + botaoDeExcluir +
                        "</td></tr>";

                    $("#linha-de-adicao-de-requisitos").parent().prepend(html);
                }
            });
        }

        function adicionarRequisito()
        {
            var $quem = $("#requisito-quem");
            var $oQue = $("#requisito-o-que");
            var $porque = $("#requisito-porque");
            
            var json = [{
                quem: $quem.val(),
                oQue: $oQue.val(),
                porque: $porque.val()
            }];

            $quem.val('');
            $oQue.val('');
            $porque.val('');

            if (!projetoCorrente.Requisitos)
                projetoCorrente.Requisitos = json;
            else
                projetoCorrente.Requisitos = projetoCorrente.Requisitos.concat(json);

            var updates = {};
            
            updates['/Projeto/' + idDoProjetoCorrente] = projetoCorrente;

            database.ref().update(updates);

            aoSalvarRegistro($quem);
        }

        function aoSalvarRegistro($quem)
        {
             database.ref('/Projeto/' + idDoProjetoCorrente).once('value').then(
                function(snapshot) 
                { 
                    atualizarTabelaDeRequisitos(snapshot.val());
                });

            toastr.success('O registro foi salvo com sucesso', 'Ótimo!');
            $quem.focus();   
        }

        function excluirRequisito(elemento)
        {
            var $elemento = $(elemento);
            var idDoRequisito = $elemento.data('id-do-requisito');

            database.ref('/Projeto/' + idDoProjetoCorrente + "/Requisitos/" + idDoRequisito).remove();

            database.ref('/Projeto/' + idDoProjetoCorrente).once('value').then(
                function(snapshot) 
                { 
                    atualizarTabelaDeRequisitos(snapshot.val());
                });

            toastr.success('O registro foi excluído com sucesso', 'Ótimo!');
        }

        function darUmLance()
        {
            projetoCorrente.Propostas = JSON.parse('[{"Descricao": "'  + $("#descricao-da-proposta").val() + '"}]');
            
            var updates = {};
            
            updates['/Projeto/' + idDoProjetoCorrente] = projetoCorrente;
            
            database.ref().update(updates);

            atualizarPropostas();

            toastr.success('A sua proposta foi enviada!', 'Ótimo!');

            $("#dar-um-lance").modal('hide');
            $("#botao-dar-um-lance").hide();
        }

        function atualizarPropostas(projetoJson)
        {
            database.ref('/Projeto/' + idDoProjetoCorrente).once('value')
            .then(function(snapshot)  { 
                    projetoJson = snapshot.val();
                    
                    if (!projetoJson.Propostas)
                    {
                        $("#botao-dar-um-lance").show();
                    }

                    for(var i = 0; i < projetoJson.Propostas.length; i++)
                    {
                        var  proposta = projetoJson.Propostas[i];

                        $("#nome-do-estudante").html("Betão");
                        $("#proposta-do-estudante").html(proposta.Descricao);

                        var htmlDoTemplate = '<div class="feed-element">' + $("#propostas-template").html() + '</div>';

                        $("#lances-do-projeto-content .feed-activity-list").prepend(htmlDoTemplate);
                    }
                });
        }
    </script>
</body>

</html>
